<html>
	<head>
		<title>Wikipedia Chain</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content="Clicking random links on Wikipedia articles couldn't be more fun." />
		<style type="text/css">
			body {
				font-family: sans-serif;
			}
			input {
				margin: 0.1em 0;
			}
		</style>
		<script type="text/javascript">
			function pageUrl(wiki, page) {
				return wiki + '/index.php?title=' + encodeURIComponent(page.replace(/ /g, '_'));
			}

			function loadPage(wiki, page) {
				console.log('Loading page: ' + page);

				var sc = document.createElement('script');
				sc.setAttribute('src', wiki + '/api.php?action=parse&format=json&callback=window.chain&redirects=1&page=' + encodeURIComponent(page.replace(/ /g, '_')));
				document.head.appendChild(sc);
			}

			function loadRandom(wiki) {
				console.log('Loading random page');

				var sc = document.createElement('script');
				sc.setAttribute('src', wiki + '/api.php?action=query&list=random&rnnamespace=0&format=json&callback=window.randomPage');
				document.head.appendChild(sc);
			}

			function updateStatus(chainLength) {
				var statusDisplay = document.getElementById('status');
				if (chainLength == 0) {
					statusDisplay.style.display = 'none';
				} else {
					statusDisplay.style.display = 'inline';
					statusDisplay.innerHTML = 'Pages remaining: <b>' + chainLength + '</b>';
				}
			}

			function updateRandom(clear) {
				var pageInput = document.getElementById('page');
				if (clear)
					pageInput.value = '';
				document.getElementById('random').style.display = pageInput.value ? 'inline' : 'none';
			}

			function start(override) {
				if (!override && window.chainLength && (window.chainLength > 0)) {
					/* Cancel button. */
					document.location.reload();
					return false;
				}

				var page = override || document.getElementById('page').value;
				window.wikiUrl = document.getElementById('wikiurl').value;
				window.chainLength = parseInt(document.getElementById('length').value) - 1;

				document.getElementById('submitbtn').value = 'Cancel';

				window.seenPages = [];
				updateStatus(window.chainLength);
				document.getElementById('chainStart').innerHTML = page ? ('<a href="' + pageUrl(window.wikiUrl, page) + '">' + page + '</a><span id="showChain"> &gt; <a href="javascript:;" onClick="document.getElementById(\'showChain\').style.display = \'none\'; document.getElementById(\'chainMiddle\').style.display = \'inline\'; return false;">[show]</a></span>') : 'Loading random page...';
				var chainMiddle = document.getElementById('chainMiddle');
				chainMiddle.style.display = 'none';
				chainMiddle.innerHTML = '';
				document.getElementById('chainEnd').innerHTML = '';

				if (page) {
					window.seenPages.push(page);
					loadPage(window.wikiUrl, page);
				} else {
					/* Load random page and start again from the random page callback. */
					loadRandom(window.wikiUrl);
				}
				return false;
			}

			function cleanScripts() {
				/* Based on: http://stackoverflow.com/questions/9390445/remove-appended-script-javascript */
				var scripts = document.getElementsByTagName('script');
				for (var i = scripts.length; i >= 0; i--) {
					if (scripts[i] && (scripts[i].getAttribute('src') != null))
						scripts[i].parentNode.removeChild(scripts[i]);
				}
			}

			function chain(json) {
				cleanScripts();

				if (!json['parse']) {
					console.log('Bad data!');
					console.log(json);

					if (json['error']) {
						if (json['error']['code'] == 'missingtitle') {
							if (parseInt(document.getElementById('length').value) == (chainLength + 1)) {
								/* Check if it's the starting page that is the one not found. */
								alert('Start page not found');
								document.getElementById('submitbtn').value = 'Start';
								document.getElementById('chainStart').innerHTML = '';
								document.getElementById('chainMiddle').innerHTML = '';
								document.getElementById('chainEnd').innerHTML = '';
								updateStatus(window.chainLength = 0);
							} else {
								loadRandom(window.wikiUrl);
								return;
							}
						} else {
							alert('API error: ' + json['error']['info']);
						}
					} else {
						alert('API returned bad data for a page');
					}
					return;
				}

				var links = json['parse']['links'];
				var candidates = [];
				for (var link in links) {
					var pageEntry = links[link];
					if (('exists' in pageEntry) && (pageEntry['*'].indexOf(':') == -1) && (window.seenPages.indexOf(pageEntry['*']) == -1))
						candidates.push(pageEntry);
				}
				if (!candidates.length)
					return loadRandom(window.wikiUrl);

				var page = candidates[Math.floor(Math.random() * candidates.length)]['*'];
				window.seenPages.push(page);

				var isEnd = --window.chainLength == 0;
				updateStatus(window.chainLength);

				document.getElementById(isEnd ? 'chainEnd' : 'chainMiddle').innerHTML += ' &gt; <a href="' + pageUrl(window.wikiUrl, page) + '">' + page + '</a>';

				if (isEnd) {
					document.getElementById('submitbtn').value = 'Start';
					return;
				}

				loadPage(window.wikiUrl, page);
			}
			window.chain = chain;

			function randomPage(json) {
				cleanScripts();

				if (!json['query'] || !json['query']['random'] || !json['query']['random'][0])
					return alert('Tried requesting random page, didn\'t get any');

				page = json['query']['random'][0]['title'];
				if (!window.seenPages.length)
					return start(page); /* start chain with random page */

				document.getElementById('chainMiddle').innerHTML += ' &gt; [chain died, random page] <a href="' + pageUrl(window.wikiUrl, page) + '">' + page + '</a>';

				isEnd = --window.chainLength == 0;
				updateStatus(window.chainLength);
				if (isEnd)
					return;

				loadPage(window.wikiUrl, page);
			}
			window.randomPage = randomPage;

			window.onload = function() {
				document.forms[0].style.display = 'block';
			};
		</script>
	</head>
	<body>
		<h1>Wikipedia Chain</h1>
		<p>Inspired by <a href="https://xkcd.com/214/">xkcd's The Problem With Wikipedia</a>, this experiment takes an article from Wikipedia (or other wikis), clicks a random link to another article and repeats the process. You can end up in the most unexpected places.</p>
		<p>Also available as a <a rel="me" href="https://mastodon.xyz/@wikipediachain">Fediverse feed</a>.</p>
		<noscript>
			<p><b>JavaScript is required to use this page.</b></p>
		</noscript>
		<form onsubmit="return start()" style="display: none;">
			Article: <input type="text" id="page" value="Main Page" placeholder="[Random]" size="20" oninput="updateRandom()" onkeypress="updateRandom()" onchange="updateRandom()" /><span id="random"> or <button type="button" onclick="updateRandom(true)">random</button></span><br />
			Wiki URL: <input type="text" id="wikiurl" value="https://en.wikipedia.org/w" size="30" /> (must contain MediaWiki api.php)<br />
			Links to click: <input type="number" id="length" min="3" value="15" style="width: 50px;" /><br />
			<input type="submit" id="submitbtn" value="Start" />
		</form>
		<p>
			<span id="chainStart"></span>
			<span id="chainMiddle" style="display: none;"></span>
			<span id="chainEnd"></span>
		</p>
		<p>
			<span id="status" style="display: none;"></span>
		</p>
	</body>
</html>
